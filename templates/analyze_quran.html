{% extends "base.html" %} {% block content %}
<div class="bg-emerald-50 min-h-screen py-10">
  <div class="container mx-auto px-6">
    <!-- Back Button -->
    <div class="mb-6">
      <a
        href="{{ url_for('index') }}"
        class="inline-flex items-center text-emerald-700 hover:underline"
      >
        <i class="fa-solid fa-arrow-left mr-2"></i> Kembali
      </a>
    </div>

    <!-- Title -->
    <div class="text-center mb-10">
      <div
        class="flex justify-center items-center gap-2 text-emerald-600 text-4xl mb-3"
      >
        <i class="fa-solid fa-book-open-reader"></i>
      </div>
      <h1 class="text-3xl md:text-4xl font-extrabold text-emerald-800">
        Analisis Dokumen Keagamaan
      </h1>
      <p class="text-slate-600 mt-3 max-w-2xl mx-auto">
        Platform khusus untuk analisis topik teks Al-Qur'an, Hadis, dan dokumen
        keagamaan lainnya dengan pengenalan struktur surat, ayat, dan riwayat
        hadis
      </p>
    </div>

    <!-- Tabs -->
    <div class="flex justify-center mb-10">
      <div
        class="bg-white shadow-sm rounded-lg flex overflow-hidden text-sm font-medium"
      >
        <button
          id="tab-upload"
          class="tab-btn px-6 py-3 flex items-center gap-2 text-emerald-700 border-b-2 border-emerald-600"
        >
          <i class="fa-solid fa-upload"></i> Upload Dokumen
        </button>
        <button
          id="tab-preprocess"
          class="tab-btn px-6 py-3 flex items-center gap-2 text-slate-500 hover:text-emerald-600"
        >
          <i class="fa-solid fa-gears"></i> Preprocessing
        </button>
        <button
          id="tab-analysis"
          class="tab-btn px-6 py-3 flex items-center gap-2 text-slate-500 hover:text-emerald-600"
        >
          <i class="fa-solid fa-chart-simple"></i> Hasil Analisis
        </button>
        <!-- tambaahan -->
        <div id="content-result" class="tab-content hidden">
          <div
            class="bg-white rounded-xl p-8 shadow-sm border border-emerald-100"
          >
            <h2
              class="text-lg font-semibold mb-4 flex items-center gap-2 text-emerald-800"
            >
              <i class="fa-solid fa-chart-line"></i> Hasil Analisis Topik
            </h2>
            <div id="analysisResult" class="text-slate-700 space-y-4">
              <p>Belum ada hasil analisis.</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tab Content -->
    <!-- <div id="content-upload" class="tab-content block">
      <div class="bg-white rounded-xl p-8 shadow-sm border border-emerald-100">
        <h2 class="text-lg font-semibold mb-6 flex items-center gap-2 text-emerald-800">
          <i class="fa-solid fa-cloud-arrow-up text-emerald-600"></i> Upload Dokumen Keagamaan
        </h2>
        <form action="{{ url_for('upload') }}" method="post" enctype="multipart/form-data" class="border-2 border-dashed border-emerald-300 rounded-lg p-10 text-center">
          <div class="text-5xl text-emerald-400 mb-4"><i class="fa-solid fa-upload"></i></div>
          <p class="font-medium text-slate-700 mb-2">Upload file dokumen keagamaan</p>
          <p class="text-sm text-slate-500 mb-4">Drag & drop file atau klik untuk memilih<br>Mendukung format: PDF, TXT, CSV (Max 10MB per file)</p>
          <input type="file" name="file" class="hidden" id="fileInput" accept=".pdf,.txt,.csv" required>
          <label for="fileInput" class="cursor-pointer bg-emerald-600 text-white px-5 py-2 rounded-lg hover:bg-emerald-700 inline-flex items-center gap-2">
            <i class="fa-solid fa-folder-open"></i> Pilih File
          </label>
          <button type="submit" class="mt-3 block mx-auto bg-slate-900 text-white px-5 py-2 rounded-lg hover:opacity-95">
            <i class="fa-solid fa-paper-plane"></i> Upload
          </button>
        </form>
      </div>
    </div> -->
    <div id="content-upload" class="tab-content block">
      <div class="bg-white rounded-xl p-8 shadow-sm border border-emerald-100">
        <!-- Download Template -->
        <div
          class="mb-6 bg-emerald-50 border border-emerald-200 rounded-lg p-6 relative"
        >
          <h3
            id="toggleTemplateInfo"
            class="text-lg font-semibold text-emerald-800 flex items-center gap-2 mb-3"
          >
            <i class="fa-solid fa-download"></i> Download Template
          </h3>
          <div
            id="templateInfo"
            class="hidden opacity-0 transition-opacity duration-500"
          >
            <p class="font-medium text-purple-700 mb-3">
              Format CSV harus mengandung kolom berikut:
            </p>
            <ul
              class="list-disc list-inside text-sm text-slate-700 space-y-1 mb-5"
            >
              <li>
                <strong>book:</strong> Nama kitab suci (contoh: Bible, Quran,
                Bhagavad Gita)
              </li>
              <li><strong>chapter:</strong> Nama atau nomor chapter/surat</li>
              <li><strong>verse:</strong> Nomor ayat</li>
              <li><strong>text:</strong> Isi teks ayat</li>
            </ul>
          </div>
          <button
            id="downloadTemplate"
            class="absolute top-6 right-6 bg-purple-600 text-white px-5 py-2 rounded-md hover:bg-purple-700 flex items-center gap-2"
          >
            <i class="fa-solid fa-cloud-arrow-down"></i> Download CSV Template
          </button>
        </div>

        <!-- Judul -->
        <h2
          class="text-lg font-semibold mb-6 flex items-center gap-2 text-emerald-800"
        >
          <i class="fa-solid fa-cloud-arrow-up text-emerald-600"></i> Upload
          Dokumen
        </h2>

        <!-- Area Upload -->
        <form
          id="uploadForm"
          enctype="multipart/form-data"
          class="border-2 border-dashed border-emerald-300 rounded-lg p-10 text-center relative"
        >
          <div class="text-5xl text-emerald-400 mb-4">
            <i class="fa-solid fa-upload"></i>
          </div>
          <p class="font-medium text-slate-700 mb-2">Upload file dokumen</p>
          <p class="text-sm text-slate-500 mb-4">
            Drag & drop file atau klik untuk memilih<br />Mendukung PDF, TXT,
            CSV (Max 10MB per file)
          </p>
          <input
            type="file"
            id="fileInput"
            name="file"
            class="hidden"
            accept=".pdf,.txt,.csv"
            required
          />
          <label
            for="fileInput"
            class="cursor-pointer bg-emerald-600 text-white px-5 py-2 rounded-lg hover:bg-emerald-700 inline-flex items-center gap-2"
          >
            <i class="fa-solid fa-folder-open"></i> Pilih File
          </label>
          <button
            type="submit"
            class="mt-3 block mx-auto bg-slate-900 text-white px-5 py-2 rounded-lg hover:opacity-95"
          >
            <i class="fa-solid fa-paper-plane"></i> Upload
          </button>
        </form>

        <!-- File yang diunggah -->
        <div
          id="uploadedFileInfo"
          class="hidden mt-6 bg-emerald-50 border border-emerald-200 rounded-lg p-4 flex items-center gap-3 text-slate-700"
        >
          <i class="fa-solid fa-file-lines text-emerald-500 text-2xl"></i>
          <div>
            <p id="fileName" class="font-medium"></p>
            <p id="fileSize" class="text-sm text-slate-500"></p>
          </div>
        </div>

        <!-- Button lanjut -->
        <div id="nextStep" class="hidden mt-6 text-center">
          <button
            id="btnNext"
            class="bg-emerald-600 text-white px-6 py-2 rounded-lg hover:bg-emerald-700 inline-flex items-center gap-2"
          >
            <i class="fa-solid fa-arrow-right"></i> Lanjut ke Preprocessing
          </button>
        </div>

        <!-- Catatan -->
        <div
          class="mt-8 bg-blue-50 border border-blue-200 rounded-lg p-5 text-sm text-slate-600"
        >
          <h3 class="font-semibold text-blue-700 flex items-center gap-2 mb-2">
            <i class="fa-solid fa-circle-info"></i> Catatan
          </h3>
          <ul class="list-disc list-inside space-y-1">
            <li>
              Dokumen akan diproses dengan pipeline preprocessing yang dapat
              dikustomisasi
            </li>
            <li>Sistem akan mengekstraksi teks dari PDF secara otomatis</li>
            <li>
              Format CSV harus memiliki kolom <code>text</code> atau
              <code>content</code>
            </li>
          </ul>
        </div>

        <!-- Message box -->
        <div
          id="messageBox"
          class="fixed top-5 right-5 hidden bg-emerald-100 border border-emerald-300 text-emerald-800 px-5 py-3 rounded-lg shadow-lg flex items-center gap-2 animate-fade-in"
        >
          <i class="fa-solid fa-circle-check"></i>
          <span>File berhasil diunggah!</span>
        </div>
      </div>
    </div>

    <!-- Preprocessing Content -->
    <div id="content-preprocess" class="tab-content hidden">
      <div class="bg-white rounded-xl p-8 shadow-sm border border-emerald-100">
        <h2
          class="text-lg font-semibold mb-4 flex items-center gap-2 text-emerald-800"
        >
          <i class="fa-solid fa-gears text-emerald-600"></i> Konfigurasi
          Preprocessing
        </h2>

        <div id="preprocessOptions" class="space-y-3">
          <div
            class="option bg-slate-50 p-4 rounded-lg border flex justify-between items-center cursor-pointer"
          >
            <div>
              <p class="font-semibold text-slate-800">Case Folding</p>
              <p class="text-sm text-slate-500 hidden">
                Konversi semua teks ke huruf kecil
              </p>
            </div>
            <label class="inline-flex items-center cursor-pointer">
              <input
                type="checkbox"
                id="case_folding"
                checked
                class="sr-only peer"
              />
              <div
                class="w-10 h-6 bg-gray-300 peer-checked:bg-emerald-600 rounded-full relative transition"
              >
                <div
                  class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition peer-checked:translate-x-4"
                ></div>
              </div>
            </label>
          </div>

          <div
            class="option bg-slate-50 p-4 rounded-lg border flex justify-between items-center cursor-pointer"
          >
            <div>
              <p class="font-semibold text-slate-800">Remove Punctuation</p>
              <p class="text-sm text-slate-500 hidden">Menghapus tanda baca</p>
            </div>
            <label class="inline-flex items-center cursor-pointer">
              <input
                type="checkbox"
                id="remove_punct"
                checked
                class="sr-only peer"
              />
              <div
                class="w-10 h-6 bg-gray-300 peer-checked:bg-emerald-600 rounded-full relative transition"
              >
                <div
                  class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition peer-checked:translate-x-4"
                ></div>
              </div>
            </label>
          </div>

          <div
            class="option bg-slate-50 p-4 rounded-lg border flex justify-between items-center cursor-pointer"
          >
            <div>
              <p class="font-semibold text-slate-800">Remove Numbers</p>
              <p class="text-sm text-slate-500 hidden">
                Menghapus angka dari teks
              </p>
            </div>
            <label class="inline-flex items-center cursor-pointer">
              <input
                type="checkbox"
                id="remove_numbers"
                checked
                class="sr-only peer"
              />
              <div
                class="w-10 h-6 bg-gray-300 peer-checked:bg-emerald-600 rounded-full relative transition"
              >
                <div
                  class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition peer-checked:translate-x-4"
                ></div>
              </div>
            </label>
          </div>

          <div
            class="option bg-slate-50 p-4 rounded-lg border flex justify-between items-center cursor-pointer"
          >
            <div>
              <p class="font-semibold text-slate-800">Stopword Removal</p>
              <p class="text-sm text-slate-500 hidden">Menghapus kata umum</p>
            </div>
            <label class="inline-flex items-center cursor-pointer">
              <input
                type="checkbox"
                id="stopword"
                checked
                class="sr-only peer"
              />
              <div
                class="w-10 h-6 bg-gray-300 peer-checked:bg-emerald-600 rounded-full relative transition"
              >
                <div
                  class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition peer-checked:translate-x-4"
                ></div>
              </div>
            </label>
          </div>

          <div
            class="option bg-slate-50 p-4 rounded-lg border flex justify-between items-center cursor-pointer"
          >
            <div>
              <p class="font-semibold text-slate-800">Tokenization</p>
              <p class="text-sm text-slate-500 hidden">
                Memecah teks menjadi token
              </p>
            </div>
            <label class="inline-flex items-center cursor-pointer">
              <input
                type="checkbox"
                id="tokenization"
                checked
                class="sr-only peer"
              />
              <div
                class="w-10 h-6 bg-gray-300 peer-checked:bg-emerald-600 rounded-full relative transition"
              >
                <div
                  class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition peer-checked:translate-x-4"
                ></div>
              </div>
            </label>
          </div>

          <div
            class="option bg-slate-50 p-4 rounded-lg border flex justify-between items-center cursor-pointer"
          >
            <div>
              <p class="font-semibold text-slate-800">Stemming</p>
              <p class="text-sm text-slate-500 hidden">
                Mengubah kata ke bentuk dasar
              </p>
            </div>
            <label class="inline-flex items-center cursor-pointer">
              <input
                type="checkbox"
                id="stemming"
                checked
                class="sr-only peer"
              />
              <div
                class="w-10 h-6 bg-gray-300 peer-checked:bg-emerald-600 rounded-full relative transition"
              >
                <div
                  class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition peer-checked:translate-x-4"
                ></div>
              </div>
            </label>
          </div>

          <div
            class="option bg-slate-50 p-4 rounded-lg border flex justify-between items-center cursor-pointer"
          >
            <div>
              <p class="font-semibold text-slate-800">Lemmatization</p>
              <p class="text-sm text-slate-500 hidden">
                Normalisasi kata ke bentuk leksikon
              </p>
            </div>
            <label class="inline-flex items-center cursor-pointer">
              <input
                type="checkbox"
                id="lemmatization"
                checked
                class="sr-only peer"
              />
              <div
                class="w-10 h-6 bg-gray-300 peer-checked:bg-emerald-600 rounded-full relative transition"
              >
                <div
                  class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition peer-checked:translate-x-4"
                ></div>
              </div>
            </label>
          </div>
        </div>

        <div class="mt-8 flex justify-between items-center">
          <button
            id="btnBack"
            class="bg-slate-200 px-5 py-2 rounded-lg hover:bg-slate-300 flex items-center gap-2"
          >
            <i class="fa-solid fa-arrow-left"></i> Kembali
          </button>
          <div class="flex items-center gap-3">
            <button
              id="btnPreprocess"
              class="bg-emerald-600 text-white px-6 py-2 rounded-lg hover:bg-emerald-700 inline-flex items-center gap-2"
            >
              <i class="fa-solid fa-play"></i> Mulai Preprocessing
            </button>
            <a
              id="btnDownload"
              href="#"
              class="hidden bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-700 inline-flex items-center gap-2"
            >
              <i class="fa-solid fa-download"></i> Download Hasil
            </a>
          </div>
        </div>
      </div>

      <hr class="my-8 border-emerald-200" />

      <!-- Pilihan Model Analisis -->
      <div class="bg-emerald-50 p-6 rounded-lg border border-emerald-200 mt-6">
        <h3 class="text-emerald-800 font-semibold mb-4 flex items-center gap-2">
          <i class="fa-solid fa-brain"></i> Model Analisis Topik
        </h3>

        <div id="modelButtons" class="flex flex-wrap gap-4">
          <label
            class="flex items-center gap-2 cursor-pointer bg-white px-4 py-2 rounded-lg border border-emerald-300 hover:bg-emerald-100 transition"
          >
            <input
              type="checkbox"
              name="model"
              value="lda"
              class="text-emerald-600 focus:ring-emerald-500"
              checked
            />
            <span class="font-medium text-slate-700"
              >LDA (Latent Dirichlet Allocation)</span
            >
          </label>
          <label
            class="flex items-center gap-2 cursor-pointer bg-white px-4 py-2 rounded-lg border border-emerald-300 hover:bg-emerald-100 transition"
          >
            <input
              type="checkbox"
              name="model"
              value="ctm"
              class="text-emerald-600 focus:ring-emerald-500"
            />
            <span class="font-medium text-slate-700"
              >CTM (Correlated Topic Model)</span
            >
          </label>
          <label
            class="flex items-center gap-2 cursor-pointer bg-white px-4 py-2 rounded-lg border border-emerald-300 hover:bg-emerald-100 transition"
          >
            <input
              type="checkbox"
              name="model"
              value="bertopic"
              class="text-emerald-600 focus:ring-emerald-500"
            />
            <span class="font-medium text-slate-700">BERTopic</span>
          </label>
        </div>

        <div class="mt-6 flex justify-end gap-3">
          <button
            id="btnAnalyze"
            class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 inline-flex items-center gap-2"
          >
            <i class="fa-solid fa-magnifying-glass-chart"></i> Mulai Analisis
            Topik
          </button>
        </div>

        <div
          id="analyzeProgress"
          class="hidden mt-4 w-full bg-gray-200 rounded-full h-3 overflow-hidden"
        >
          <div
            class="bg-indigo-600 h-3 rounded-full animate-pulse w-0"
            id="progressBar"
          ></div>
        </div>

        <div
          id="preprocessInfo"
          class="hidden mt-4 text-amber-700 bg-amber-100 border border-amber-200 rounded-lg px-4 py-3 text-sm flex items-center gap-2"
        >
          <i class="fa-solid fa-circle-info"></i>
          <span
            >Anda belum melakukan preprocessing. Disarankan melakukan
            preprocessing sebelum analisis agar hasil lebih optimal.</span
          >
        </div>
      </div>
    </div>

    <!-- Hasil Analisis Content -->
    <div id="content-analysis" class="tab-content hidden">
      <div class="bg-white rounded-xl p-8 shadow-sm border border-emerald-100">
        <!-- Tombol Kembali -->
        <div class="mb-6">
          <button
            id="btnBackToPreprocess"
            class="inline-flex items-center text-emerald-700 hover:underline"
          >
            <i class="fa-solid fa-arrow-left mr-2"></i> Kembali ke Preprocessing
          </button>
        </div>

        <!-- Judul Hasil Analisis -->
        <div class="mb-8">
          <h2 class="text-2xl font-bold text-emerald-800 mb-2">
            Hasil Analisis Topik Keagamaan
          </h2>
          <p id="resultsSummary" class="text-slate-600">
            Sedang menganalisis...
          </p>
        </div>

        <!-- Progress Bar -->
        <div id="analyzeProgressContainer" class="hidden mb-8">
          <div class="flex justify-between items-center mb-2">
            <span class="text-sm font-medium text-emerald-700"
              >Sedang menganalisis...</span
            >
            <span
              id="progressPercent"
              class="text-sm font-medium text-emerald-700"
              >0%</span
            >
          </div>
          <div class="w-full bg-gray-200 rounded-full h-3">
            <div
              id="analyzeProgressBar"
              class="bg-emerald-600 h-3 rounded-full transition-all duration-300"
              style="width: 0%"
            ></div>
          </div>
        </div>

        <!-- Tab Navigation untuk hasil analisis -->
        <div class="mb-6 border-b border-emerald-200">
          <nav class="-mb-px flex space-x-8">
            <button
              class="analysis-tab-btn border-b-2 border-emerald-500 text-emerald-600 px-1 py-4 text-sm font-medium"
              data-tab="topics"
            >
              <i class="fa-solid fa-list mr-2"></i>Topik Utama
            </button>
            <button
              class="analysis-tab-btn border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300 px-1 py-4 text-sm font-medium"
              data-tab="sources"
            >
              <i class="fa-solid fa-book mr-2"></i>Sumber & Referensi
            </button>
            <button
              class="analysis-tab-btn border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300 px-1 py-4 text-sm font-medium"
              data-tab="visualization"
            >
              <i class="fa-solid fa-chart-bar mr-2"></i>Visualisasi
            </button>
            <button
              class="analysis-tab-btn border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300 px-1 py-4 text-sm font-medium"
              data-tab="search"
            >
              <i class="fa-solid fa-search mr-2"></i>Pencarian
            </button>
          </nav>
        </div>

        <!-- Tab Content untuk hasil analisis -->

        <!-- Tab 1: Topik Utama -->
        <div id="tab-topics" class="analysis-tab-content space-y-6">
          <div id="modelResultsContainer">
            <!-- Hasil dari setiap model akan ditampilkan di sini -->
          </div>
        </div>

        <!-- Tab 2: Sumber & Referensi -->
        <div id="tab-sources" class="analysis-tab-content hidden">
          <div class="bg-slate-50 rounded-lg p-6">
            <h3 class="text-lg font-semibold text-emerald-800 mb-4">
              Dokumen Sumber
            </h3>
            <div id="sourcesContainer" class="space-y-4">
              <!-- Data sumber akan diisi oleh JavaScript -->
            </div>
          </div>
        </div>

        <!-- Tab 3: Visualisasi -->
        <div id="tab-visualization" class="analysis-tab-content hidden">
          <div class="bg-white rounded-lg border border-emerald-200 p-6">
            <h3 class="text-lg font-semibold text-emerald-800 mb-4">
              Visualisasi Hasil Analisis
            </h3>
            <div
              id="visualizationContainer"
              class="grid grid-cols-1 lg:grid-cols-2 gap-6"
            >
              <!-- Grafik akan diisi oleh JavaScript -->
              <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
                <h4 class="font-medium text-slate-700 mb-3">
                  Distribusi Topik
                </h4>
                <div
                  id="topicDistributionChart"
                  class="h-64 flex items-center justify-center text-slate-400"
                >
                  <p>Grafik distribusi topik akan ditampilkan di sini</p>
                </div>
              </div>
              <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
                <h4 class="font-medium text-slate-700 mb-3">
                  Kata Kunci Topik
                </h4>
                <div
                  id="keywordCloud"
                  class="h-64 flex items-center justify-center text-slate-400"
                >
                  <p>Word cloud akan ditampilkan di sini</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Tab 4: Pencarian -->
        <div id="tab-search" class="analysis-tab-content hidden">
          <div class="bg-white rounded-lg border border-emerald-200 p-6">
            <h3 class="text-lg font-semibold text-emerald-800 mb-4">
              Pencarian Topik dan Kata Kunci
            </h3>

            <!-- Search Box -->
            <div class="mb-6">
              <div class="relative">
                <input
                  type="text"
                  id="searchInput"
                  placeholder="Cari kata kunci atau topik..."
                  class="w-full px-4 py-3 border border-emerald-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                />
                <i
                  class="fa-solid fa-search absolute right-3 top-3 text-slate-400"
                ></i>
              </div>
            </div>

            <!-- Search Results -->
            <div id="searchResults" class="space-y-4">
              <div class="text-center text-slate-500 py-8">
                <i class="fa-solid fa-search text-3xl mb-3 text-slate-300"></i>
                <p>Masukkan kata kunci untuk mencari topik terkait</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const tabs = document.querySelectorAll(".tab-btn");
    const contents = document.querySelectorAll(".tab-content");

    tabs.forEach((tab) => {
      tab.addEventListener("click", () => {
        // reset styles
        tabs.forEach((t) =>
          t.classList.remove(
            "text-emerald-700",
            "border-b-2",
            "border-emerald-600"
          )
        );
        tabs.forEach((t) => t.classList.add("text-slate-500"));
        contents.forEach((c) => c.classList.add("hidden"));
        // activate selected
        tab.classList.add(
          "text-emerald-700",
          "border-b-2",
          "border-emerald-600"
        );
        tab.classList.remove("text-slate-500");
        document
          .getElementById("content-" + tab.id.split("-")[1])
          .classList.remove("hidden");
      });
    });
  });

  document.addEventListener("DOMContentLoaded", function () {
    const fileInput = document.getElementById("fileInput");
    const uploadForm = document.getElementById("uploadForm");
    const fileInfo = document.getElementById("uploadedFileInfo");
    const fileName = document.getElementById("fileName");
    const fileSize = document.getElementById("fileSize");
    const nextStep = document.getElementById("nextStep");
    const messageBox = document.getElementById("messageBox");
    const btnNext = document.getElementById("btnNext");

    // tampilkan info file saat dipilih
    fileInput.addEventListener("change", function () {
      const file = fileInput.files[0];
      if (file) {
        fileName.textContent = file.name;
        fileSize.textContent = (file.size / 1024).toFixed(2) + " KB";
        fileInfo.classList.remove("hidden");
      }
    });

    // upload form simulasi AJAX
    uploadForm.addEventListener("submit", async function (e) {
      e.preventDefault();

      const file = fileInput.files[0];
      if (!file) {
        alert("Silakan pilih file terlebih dahulu.");
        return;
      }

      const formData = new FormData();
      formData.append("file", file);

      const res = await fetch("/upload", { method: "POST", body: formData });
      const text = await res.text();

      if (res.ok) {
        messageBox.classList.remove("hidden");
        setTimeout(() => messageBox.classList.add("hidden"), 2000);

        // tampilkan info file di UI
        fileName.textContent = file.name;
        fileSize.textContent = (file.size / 1024).toFixed(2) + " KB";
        fileInfo.classList.remove("hidden");

        // tampilkan tombol lanjut
        nextStep.classList.remove("hidden");
      } else {
        alert("Gagal mengunggah file: " + text);
      }
      // simulasi upload
      messageBox.classList.remove("hidden");
      setTimeout(() => {
        messageBox.classList.add("hidden");
        nextStep.classList.remove("hidden");
      }, 2500);
    });

    // klik lanjut ke preprocessing
    btnNext.addEventListener("click", function () {
      document.getElementById("tab-preprocess").click();
    });
  });

  // Toggle animasi fade-in/out
  const toggle = document.getElementById("toggleTemplateInfo");
  const info = document.getElementById("templateInfo");

  toggle.addEventListener("click", () => {
    if (info.classList.contains("hidden")) {
      info.classList.remove("hidden");
      setTimeout(() => (info.style.opacity = "1"), 10);
    } else {
      info.style.opacity = "0";
      setTimeout(() => info.classList.add("hidden"), 500);
    }
  });

  // Download file CSV dari root folder
  document.getElementById("downloadTemplate").addEventListener("click", (e) => {
    e.preventDefault(); // cegah buka tab baru
    fetch("/static/template_file.csv")
      .then((response) => {
        if (!response.ok) throw new Error("File tidak ditemukan!");
        return response.blob();
      })
      .then((blob) => {
        const link = document.createElement("a");
        const url = window.URL.createObjectURL(blob);
        link.href = url;
        link.download = "template_file.csv";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        window.URL.revokeObjectURL(url);
      })
      .catch((err) => {
        console.error(err);
        alert("File template tidak ditemukan di folder static!");
      });
  });

  document.addEventListener("DOMContentLoaded", function () {
    const options = document.querySelectorAll(".option");
    options.forEach((opt) => {
      opt.addEventListener("click", () => {
        const desc = opt.querySelector("p.text-sm");
        desc.classList.toggle("hidden");
      });
    });

    const preprocessBtn = document.getElementById("btnPreprocess");
    const downloadBtn = document.getElementById("btnDownload");

    document.addEventListener("DOMContentLoaded", function () {
      const btnAnalyze = document.getElementById("btnAnalyze");
      const infoBox = document.getElementById("preprocessInfo");
      const downloadBtn = document.getElementById("btnDownload");
      let preprocessDone = false;

      // tandai jika preprocessing selesai
      document.getElementById("btnPreprocess").addEventListener("click", () => {
        setTimeout(() => (preprocessDone = true), 2000);
      });

      btnAnalyze.addEventListener("click", async () => {
        if (!preprocessDone) {
          // tampilkan info tapi tetap lanjut
          infoBox.classList.remove("hidden");
          setTimeout(() => infoBox.classList.add("hidden"), 6000);
        }
        btnAnalyze.disabled = true;
        btnAnalyze.innerHTML =
          '<i class="fa-solid fa-spinner fa-spin"></i> Menganalisis...';

        const model = document.querySelector(
          'input[name="model"]:checked'
        ).value;
        const fileName = document.getElementById("fileName").textContent;

        const formData = new FormData();
        formData.append("filename", fileName);
        formData.append("model", model);

        const res = await fetch("/analyze_model", {
          method: "POST",
          body: formData,
        });
        const data = await res.json();

        if (data.status === "success") {
          alert(`Analisis ${model.toUpperCase()} selesai!`);
          document
            .querySelectorAll(".tab-content")
            .forEach((el) => el.classList.add("hidden"));
          document.getElementById("content-result").classList.remove("hidden");
          document
            .getElementById("tab-result")
            .classList.add("text-indigo-600", "font-semibold");
          document.getElementById("analysisResult").innerHTML = data.html;
        } else {
          alert("Gagal melakukan analisis topik: " + data.message);
        }

        btnAnalyze.disabled = false;
        btnAnalyze.innerHTML =
          '<i class="fa-solid fa-magnifying-glass-chart"></i> Mulai Analisis Topik';
      });
    });
    preprocessBtn.addEventListener("click", async () => {
      preprocessBtn.disabled = true;
      preprocessBtn.innerHTML =
        '<i class="fa-solid fa-spinner fa-spin"></i> Memproses...';

      const fileName = document.getElementById("fileName").textContent;
      const formData = new FormData();
      formData.append("filename", fileName);
      [
        "case_folding",
        "remove_punct",
        "remove_numbers",
        "stopword",
        "tokenization",
        "stemming",
        "lemmatization",
      ].forEach((id) => {
        formData.append(id, document.getElementById(id).checked);
      });

      const res = await fetch("/preprocess", {
        method: "POST",
        body: formData,
      });
      const data = await res.json();

      if (data.status === "success") {
        downloadBtn.href = `/uploads/${data.file}`;
        downloadBtn.classList.remove("hidden");
        alert("Preprocessing selesai! File siap diunduh.");
      } else {
        alert("Gagal melakukan preprocessing: " + data.message);
      }

      preprocessBtn.disabled = false;
      preprocessBtn.innerHTML =
        '<i class="fa-solid fa-play"></i> Mulai Preprocessing';
    });

    // Tombol kembali dari hasil analisis ke preprocessing
    document
      .getElementById("btnBackToPreprocess")
      .addEventListener("click", () => {
        document.getElementById("tab-preprocess").click();
      });

    // Fungsi untuk simulasi progress bar
    function simulateProgress() {
      const progressBar = document.getElementById("analyzeProgressBar");
      const progressPercent = document.getElementById("progressPercent");
      const progressContainer = document.getElementById(
        "analyzeProgressContainer"
      );

      progressContainer.classList.remove("hidden");

      let progress = 0;
      const interval = setInterval(() => {
        progress += Math.random() * 10;
        if (progress >= 100) {
          progress = 100;
          clearInterval(interval);

          // Setelah selesai, tampilkan hasil analisis
          setTimeout(() => {
            showAnalysisResults();
          }, 500);
        }

        progressBar.style.width = `${progress}%`;
        progressPercent.textContent = `${Math.round(progress)}%`;
      }, 200);
    }

    // Fungsi untuk menampilkan hasil analisis
    function showAnalysisResults() {
      const progressContainer = document.getElementById(
        "analyzeProgressContainer"
      );
      const resultsBody = document.getElementById("analysisResultsBody");
      const resultsContent = document.getElementById("analysisResultsContent");

      progressContainer.classList.add("hidden");

      // Sembunyikan placeholder dan tampilkan hasil
      resultsBody.innerHTML = "";
      resultsContent.classList.remove("hidden");

      // Scroll ke hasil analisis
      resultsContent.scrollIntoView({ behavior: "smooth" });
    }

    // Update event listener untuk tombol analisis
    document
      .getElementById("btnAnalyze")
      .addEventListener("click", async () => {
        const models = Array.from(
          document.querySelectorAll('input[name="model"]:checked')
        ).map((el) => el.value);

        if (models.length === 0) {
          alert("Pilih setidaknya satu model analisis!");
          return;
        }

        // Buka tab hasil analisis
        document.getElementById("tab-analysis").click();

        // Mulai progress bar
        simulateProgress();
      });

    // Variabel global untuk menyimpan hasil analisis
    let analysisResults = {};

    // Fungsi untuk menampilkan progress bar
    function showProgressBar() {
      const progressContainer = document.getElementById(
        "analyzeProgressContainer"
      );
      const progressBar = document.getElementById("analyzeProgressBar");
      const progressPercent = document.getElementById("progressPercent");

      progressContainer.classList.remove("hidden");

      let progress = 0;
      const interval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress >= 100) {
          progress = 100;
          clearInterval(interval);
        }

        progressBar.style.width = `${progress}%`;
        progressPercent.textContent = `${Math.round(progress)}%`;
      }, 200);
    }

    // Fungsi untuk menyembunyikan progress bar
    function hideProgressBar() {
      const progressContainer = document.getElementById(
        "analyzeProgressContainer"
      );
      progressContainer.classList.add("hidden");
    }

    // Fungsi untuk menampilkan hasil analisis di tab Topik Utama
    function displayTopicResults(results) {
      const container = document.getElementById("modelResultsContainer");
      container.innerHTML = "";

      results.forEach((result) => {
        const modelSection = document.createElement("div");
        modelSection.className =
          "bg-emerald-50 rounded-lg p-6 border border-emerald-200";

        // Header model
        const modelHeader = document.createElement("div");
        modelHeader.className = "flex items-center justify-between mb-4";

        const modelTitle = document.createElement("h3");
        modelTitle.className = "text-xl font-bold text-emerald-800";
        modelTitle.innerHTML = `<i class="fa-solid fa-brain mr-2"></i>Hasil Model ${result.model_type.toUpperCase()}`;

        const topicCount = document.createElement("span");
        topicCount.className =
          "bg-emerald-100 text-emerald-800 px-3 py-1 rounded-full text-sm font-medium";
        topicCount.textContent = `${result.topics.length} Topik Ditemukan`;

        modelHeader.appendChild(modelTitle);
        modelHeader.appendChild(topicCount);
        modelSection.appendChild(modelHeader);

        // Daftar topik
        result.topics.forEach((topic) => {
          const topicCard = document.createElement("div");
          topicCard.className =
            "bg-white rounded-lg p-4 mb-4 border border-emerald-100";

          // Header topik
          const topicHeader = document.createElement("div");
          topicHeader.className = "flex justify-between items-start mb-3";

          const topicName = document.createElement("h4");
          topicName.className = "text-lg font-semibold text-emerald-800";
          topicName.textContent = topic.name;

          const topicPercentage = document.createElement("span");
          topicPercentage.className =
            "bg-emerald-500 text-white px-3 py-1 rounded-full text-sm font-bold";
          topicPercentage.textContent = `${topic.percentage}%`;

          topicHeader.appendChild(topicName);
          topicHeader.appendChild(topicPercentage);
          topicCard.appendChild(topicHeader);

          // Kata kunci
          const keywordsContainer = document.createElement("div");
          keywordsContainer.className = "flex flex-wrap gap-2 mb-3";

          topic.keywords.forEach((keyword) => {
            const keywordSpan = document.createElement("span");
            keywordSpan.className =
              "bg-emerald-100 text-emerald-800 px-3 py-1 rounded-full text-sm border border-emerald-200";
            keywordSpan.textContent = keyword;
            keywordsContainer.appendChild(keywordSpan);
          });

          topicCard.appendChild(keywordsContainer);

          // Sumber representatif
          if (
            topic.representative_sources &&
            topic.representative_sources.length > 0
          ) {
            const sourcesTitle = document.createElement("p");
            sourcesTitle.className = "text-sm font-medium text-slate-600 mb-2";
            sourcesTitle.textContent = "Sumber Representatif:";
            topicCard.appendChild(sourcesTitle);

            const sourcesContainer = document.createElement("div");
            sourcesContainer.className = "space-y-2";

            topic.representative_sources.forEach((source) => {
              const sourceDiv = document.createElement("div");
              sourceDiv.className =
                "text-sm text-slate-600 bg-slate-50 p-2 rounded";
              sourceDiv.innerHTML = `<strong>${source.source}:</strong> ${source.content_preview}`;
              if (source.verse) {
                sourceDiv.innerHTML += ` <span class="text-emerald-600 font-medium">(${source.verse})</span>`;
              }
              sourcesContainer.appendChild(sourceDiv);
            });

            topicCard.appendChild(sourcesContainer);
          }

          modelSection.appendChild(topicCard);
        });

        container.appendChild(modelSection);
      });
    }

    // Fungsi untuk menampilkan sumber dokumen
    function displaySources(sources) {
      const container = document.getElementById("sourcesContainer");
      container.innerHTML = "";

      if (sources.length === 0) {
        container.innerHTML = `
      <div class="text-center text-slate-500 py-8">
        <i class="fa-solid fa-book-open text-3xl mb-3 text-slate-300"></i>
        <p>Tidak ada data sumber yang tersedia</p>
      </div>
    `;
        return;
      }

      sources.forEach((source) => {
        const sourceCard = document.createElement("div");
        sourceCard.className =
          "bg-white rounded-lg p-4 border border-slate-200";

        sourceCard.innerHTML = `
      <div class="flex justify-between items-start mb-2">
        <h4 class="font-semibold text-emerald-800">${source.reference}</h4>
        <span class="bg-slate-100 text-slate-600 px-2 py-1 rounded text-xs">Dokumen ${source.doc_id}</span>
      </div>
      <p class="text-sm text-slate-600">${source.preview}</p>
    `;

        container.appendChild(sourceCard);
      });
    }

    // Fungsi untuk menampilkan visualisasi
    function displayVisualization(visualizationData) {
      const container = document.getElementById("visualizationContainer");

      // Untuk sekarang kita buat visualisasi sederhana
      // Dalam implementasi nyata, Anda bisa menggunakan Chart.js atau library lain
      let visualizationHTML = "";

      visualizationData.forEach((data) => {
        visualizationHTML += `
      <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
        <h4 class="font-medium text-slate-700 mb-3">Distribusi Topik - ${
          data.model_type
        }</h4>
        <div class="space-y-2">
          ${data.topic_names
            .map(
              (name, index) => `
            <div class="flex items-center justify-between">
              <span class="text-sm text-slate-600">${name}</span>
              <div class="w-32 bg-slate-200 rounded-full h-2">
                <div class="bg-emerald-500 h-2 rounded-full" style="width: ${data.topic_distribution[index]}%"></div>
              </div>
              <span class="text-sm font-medium text-emerald-600">${data.topic_distribution[index]}%</span>
            </div>
          `
            )
            .join("")}
        </div>
      </div>
    `;
      });

      container.innerHTML = visualizationHTML;
    }

    // Fungsi untuk menangani pencarian
    function setupSearchFunctionality(searchData) {
      const searchInput = document.getElementById("searchInput");
      const searchResults = document.getElementById("searchResults");

      searchInput.addEventListener("input", function (e) {
        const query = e.target.value.toLowerCase().trim();

        if (query.length < 2) {
          searchResults.innerHTML = `
        <div class="text-center text-slate-500 py-8">
          <i class="fa-solid fa-search text-3xl mb-3 text-slate-300"></i>
          <p>Masukkan minimal 2 karakter untuk mencari</p>
        </div>
      `;
          return;
        }

        const filteredResults = searchData.filter(
          (item) =>
            item.keyword.toLowerCase().includes(query) ||
            item.topic_name.toLowerCase().includes(query)
        );

        if (filteredResults.length === 0) {
          searchResults.innerHTML = `
        <div class="text-center text-slate-500 py-8">
          <i class="fa-solid fa-search text-3xl mb-3 text-slate-300"></i>
          <p>Tidak ditemukan hasil untuk "${query}"</p>
        </div>
      `;
          return;
        }

        // Kelompokkan hasil berdasarkan topik
        const groupedResults = {};
        filteredResults.forEach((item) => {
          if (!groupedResults[item.topic_id]) {
            groupedResults[item.topic_id] = {
              topic_name: item.topic_name,
              percentage: item.percentage,
              keywords: [],
            };
          }
          groupedResults[item.topic_id].keywords.push(item.keyword);
        });

        let resultsHTML = "";
        Object.values(groupedResults).forEach((topic) => {
          resultsHTML += `
        <div class="bg-white rounded-lg p-4 border border-emerald-200">
          <div class="flex justify-between items-start mb-3">
            <h4 class="font-semibold text-emerald-800">${topic.topic_name}</h4>
            <span class="bg-emerald-100 text-emerald-800 px-2 py-1 rounded text-sm">${
              topic.percentage
            }%</span>
          </div>
          <div class="flex flex-wrap gap-2">
            ${topic.keywords
              .map(
                (keyword) => `
              <span class="bg-emerald-50 text-emerald-700 px-3 py-1 rounded-full text-sm border border-emerald-200">${keyword}</span>
            `
              )
              .join("")}
          </div>
        </div>
      `;
        });

        searchResults.innerHTML = resultsHTML;
      });
    }

    // Event listener untuk tab hasil analisis
    document.querySelectorAll(".analysis-tab-btn").forEach((button) => {
      button.addEventListener("click", function () {
        // Update active tab
        document.querySelectorAll(".analysis-tab-btn").forEach((btn) => {
          btn.classList.remove("border-emerald-500", "text-emerald-600");
          btn.classList.add("border-transparent", "text-slate-500");
        });
        this.classList.add("border-emerald-500", "text-emerald-600");
        this.classList.remove("border-transparent", "text-slate-500");

        // Show corresponding tab content
        const tabName = this.getAttribute("data-tab");
        document
          .querySelectorAll(".analysis-tab-content")
          .forEach((content) => {
            content.classList.add("hidden");
          });
        document.getElementById(`tab-${tabName}`).classList.remove("hidden");

        // Load data untuk tab yang dipilih
        if (tabName === "sources" && analysisResults.sources) {
          displaySources(analysisResults.sources);
        } else if (
          tabName === "visualization" &&
          analysisResults.visualization_data
        ) {
          displayVisualization([analysisResults.visualization_data]);
        } else if (tabName === "search" && analysisResults.search_data) {
          setupSearchFunctionality(analysisResults.search_data);
        }
      });
    });

    // Update event listener untuk tombol analisis
    document
      .getElementById("btnAnalyze")
      .addEventListener("click", async function () {
        const models = Array.from(
          document.querySelectorAll('input[name="model"]:checked')
        ).map((el) => el.value);

        if (models.length === 0) {
          alert("Pilih setidaknya satu model analisis!");
          return;
        }

        const fileName = document.getElementById("fileName").textContent.trim();
        if (!fileName) {
          alert("Silakan unggah file terlebih dahulu!");
          return;
        }

        // Buka tab hasil analisis
        document.getElementById("tab-analysis").click();

        // Reset dan tampilkan progress bar
        showProgressBar();

        // Update summary
        document.getElementById(
          "resultsSummary"
        ).textContent = `Menganalisis dengan ${models.length} model...`;

        // Kirim permintaan untuk setiap model
        let allResults = [];
        let allSearchData = [];
        let allSources = [];
        let allVisualizationData = [];

        for (let i = 0; i < models.length; i++) {
          const model = models[i];
          const formData = new FormData();
          formData.append("filename", fileName);
          formData.append("model", model);

          try {
            const res = await fetch("/analyze_model", {
              method: "POST",
              body: formData,
            });
            const data = await res.json();

            if (data.status === "success") {
              allResults.push(data.results);
              allSearchData = allSearchData.concat(
                data.results.search_data || []
              );
              allSources = data.results.sources || [];
              allVisualizationData.push(data.results.visualization_data);
            } else {
              console.error(`Gagal untuk model ${model}:`, data.message);
            }
          } catch (error) {
            console.error(`Error untuk model ${model}:`, error);
          }
        }

        // Sembunyikan progress bar
        hideProgressBar();

        // Simpan hasil ke variabel global
        analysisResults = {
          topics: allResults,
          sources: allSources,
          visualization_data: allVisualizationData,
          search_data: allSearchData,
        };

        // Update summary
        const totalTopics = allResults.reduce(
          (sum, result) => sum + (result.topics?.length || 0),
          0
        );
        document.getElementById(
          "resultsSummary"
        ).textContent = `Ditemukan ${totalTopics} topik utama dari ${models.length} model analisis`;

        // Tampilkan hasil di tab Topik Utama
        displayTopicResults(allResults);

        // Set tab pertama sebagai aktif
        document.querySelector('.analysis-tab-btn[data-tab="topics"]').click();
      });

    // Tombol kembali dari hasil analisis ke preprocessing
    document
      .getElementById("btnBackToPreprocess")
      .addEventListener("click", function () {
        document.getElementById("tab-preprocess").click();
      });
  });
</script>

<style>
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  .animate-fade-in {
    animation: fadeIn 0.4s ease-in-out;
  }

  .analysis-tab-content {
    animation: fadeIn 0.3s ease-in-out;
  }

  /* Smooth transitions for progress bar */
  .transition-all {
    transition: all 0.3s ease;
  }
</style>

{% endblock %}
